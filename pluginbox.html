<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插件系统</title>
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <style>
        /* 基础样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }

        /* 插件管理界面加宽和紫色主题 */
        #plugin-viewer .viewer-content {
            max-width: 800px;
            width: 100%;
            position: relative;
            border-top: 5px solid #9c27b0;
        }

        #plugin-viewer h3 {
            color: #9c27b0;
            border-bottom: 1px solid #f0e6f0;
            padding-bottom: 10px;
            margin-top: 0;
        }

        /* 插件查看器的关闭按钮使用紫色 */
        #plugin-viewer .close-button {
            background-color: #9c27b0;
        }

        #plugin-viewer .close-button:hover {
            background-color: #7b1fa2;
        }

        /* 插件系统样式 - 紫色主题 */
        #plugin-viewer {
            z-index: 1001;
        }

        #plugin-list {
            margin-bottom: 20px;
            border-top: 1px solid #f0e6f0;
            padding-top: 10px;
            min-height: 100px;
        }

        .plugin-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0c8e0;
            border-radius: 4px;
            background-color: #fcfaff;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .plugin-item:hover {
            background-color: #f5edf5;
            border-color: #c9a3c9;
        }

        .plugin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plugin-name {
            font-weight: bold;
            color: #7b1fa2;
        }

        .plugin-packname {
            font-size: 0.8em;
            color: #9c27b0;
        }

        .plugin-description {
            margin-top: 5px;
            font-size: 0.9em;
            color: #5a266a;
        }

        .plugin-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e0c8e0;
            font-size: 0.85em;
            display: none;
        }

        .plugin-details.visible {
            display: block;
        }

        .plugin-section {
            margin-bottom: 8px;
        }

        .plugin-section-title {
            font-weight: bold;
            color: #7b1fa2;
            margin-bottom: 3px;
        }

        .plugin-section-content {
            color: #6a327a;
            padding-left: 10px;
        }

        /* 加号按钮：圆角正方形紫色 */
        #add-plugin-button {
            width: 40px;
            height: 40px;
            background-color: #9c27b0;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 20px;
            right: 20px;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.2s;
        }

        #add-plugin-button:hover {
            background-color: #7b1fa2;
            transform: scale(1.1);
        }

        #add-plugin-form {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0e6f0;
        }

        #add-plugin-form.visible {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #7b1fa2;
        }

        textarea, input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0c8e0;
            border-radius: 4px;
            box-sizing: border-box;
        }

        textarea:focus, input[type="file"]:focus {
            border-color: #9c27b0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.2);
        }

        textarea {
            min-height: 150px;
            font-family: monospace;
        }

        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .form-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .submit-button {
            background-color: #9c27b0;
            color: white;
        }

        .submit-button:hover {
            background-color: #7b1fa2;
        }

        .cancel-button {
            background-color: #f0e6f0;
            color: #7b1fa2;
        }

        .cancel-button:hover {
            background-color: #e0c8e0;
        }

        .error-message {
            color: #d32f2f;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .plugin-actions {
            display: flex;
            gap: 5px;
        }

        .plugin-action-button {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-button {
            background-color: #ff4444;
            color: white;
        }

        .delete-button:hover {
            background-color: #cc0000;
        }
        
        .toggle-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .toggle-button:hover {
            background-color: #45a049;
        }
        
        .toggle-button.disabled {
            background-color: #cccccc;
            color: #666666;
        }

        .install-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .install-method {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #e0c8e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .install-method:hover {
            background-color: #f5edf5;
        }

        .install-method.active {
            border-color: #9c27b0;
            background-color: #f0e6f0;
            color: #7b1fa2;
        }

        .install-content {
            display: none;
        }

        .install-content.active {
            display: block;
        }

        #no-plugins-message {
            text-align: center;
            color: #9c27b0;
            padding: 20px;
            font-style: italic;
            font-size: 0.9em;
            margin: 0;
        }

        /* 查看源代码按钮样式 */
        .view-source-button {
            background-color: #9c27b0;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 10px;
            transition: background-color 0.2s;
            width: 100%;
            text-align: center;
        }

        .view-source-button:hover {
            background-color: #7b1fa2;
        }

        /* 源代码显示区域样式 */
        .plugin-source-code {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
            border: 1px solid #e0c8e0;
        }

        .plugin-source-code.visible {
            display: block;
        }

        /* 左上角紫色拼图按钮 - 包含拼图图标 */
        #puzzle-button {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 40px;
            height: 40px;
            background-color: #9c27b0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s ease, background-color 0.2s ease;
            z-index: 100;
        }

        #puzzle-button:hover {
            background-color: #7b1fa2;
            transform: scale(1.1);
        }

        /* 拖动模式下的样式 */
        #puzzle-button.dragging {
            cursor: move;
            background-color: #6a1b88;
            box-shadow: 0 0 10px rgba(106, 27, 136, 0.5);
        }

        /* 拖动提示 */
        #drag-hint {
            position: absolute;
            left: 70px;
            top: 25px;
            background-color: #6a1b88;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 99;
        }

        /* 查看器基础样式 */
        .viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .viewer-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
        }

        .close-button {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #00BBD4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Winbox 窗口系统样式 - 修改为白色窗口和紫色标题栏 */
        .winbox {
            position: absolute;
            width: 500px;
            height: 400px;
            border: 1px solid #e0c8e0; /* 淡紫色边框 */
            background-color: white; /* 白色窗口背景 */
            color: #333; /* 深色文本 */
            overflow: hidden;
            z-index: 500;
            display: none; /* 默认隐藏 */
            border-radius: 4px; /* 轻微圆角 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* 添加阴影 */
        }
        .winbox-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: #9c27b0; /* 紫色标题栏 */
            cursor: move;
            user-select: none; /* 防止文字被选中 */
        }
        .winbox-header .title {
            font-weight: bold;
            color: white; /* 白色标题文字 */
        }
        .winbox-header .controls {
            display: flex;
        }
        .winbox-header .controls button {
            background: #7b1fa2; /* 深紫色关闭按钮 */
            border: none;
            color: white; /* 白色关闭符号 */
            font-size: 14px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .winbox-header .controls button:hover {
            background: #6a1b88; /* 更深的紫色悬停效果 */
        }
        .winbox-content {
            flex: 1;
            padding: 15px;
            box-sizing: border-box;
            overflow: auto;
        }
        .resizer {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #9c27b0; /* 紫色调整大小控件 */
            cursor: se-resize;
        }
        .dialog-buttons {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .dialog-buttons button {
            background-color: #f0e6f0;
            color: #7b1fa2;
            border: 1px solid #9c27b0;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .dialog-buttons button:hover {
            background-color: #e0c8e0;
        }
        .input-field {
            width: 100%;
            padding: 8px;
            background-color: white;
            color: #333;
            border: 1px solid #e0c8e0;
            box-sizing: border-box;
            border-radius: 3px;
        }
        .input-field:focus {
            border-color: #9c27b0;
            outline: none;
        }
    </style>
</head>
<body>
    <!-- 拖动提示 -->
    <div id="drag-hint">拖动中 - 按ESC退出</div>
    
    <!-- 左上角紫色拼图按钮 - 带有拼图图标 -->
    <button id="puzzle-button" title="插件管理">
        <i class="fas fa-puzzle-piece"></i>
    </button>

    <h1>主应用界面</h1>
    <p>点击左上角的拼图图标打开插件管理界面</p>
    <p>按Alt+M可以切换拼图按钮的拖动模式</p>
    <p>按Alt+R可以将拼图按钮重置到初始位置</p>

    <!-- 插件查看器 -->
    <div id="plugin-viewer" class="viewer">
        <div class="viewer-content">
            <h3>插件管理</h3>
            
            <!-- 带加号的紫色圆角正方形按钮，位于右上角 -->
            <button id="add-plugin-button">+</button>
            
            <!-- 插件安装表单，默认隐藏 -->
            <div id="add-plugin-form">
                <div class="install-methods">
                    <div class="install-method active" data-method="text">输入代码</div>
                    <div class="install-method" data-method="file">上传文件</div>
                </div>
                
                <div class="install-contents">
                    <div class="install-content active" id="text-install">
                        <div class="form-group">
                            <label for="plugin-code">插件代码</label>
                            <textarea id="plugin-code" placeholder="粘贴插件代码..." style="resize: none"></textarea>
                            <div id="plugin-code-error" class="error-message"></div>
                        </div>
                    </div>
                    
                    <div class="install-content" id="file-install">
                        <div class="form-group">
                            <label for="plugin-file">选择JS文件</label>
                            <input type="file" id="plugin-file" accept=".js">
                            <div id="plugin-file-error" class="error-message"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button class="form-button cancel-button" id="cancel-add-plugin">取消</button>
                    <button class="form-button submit-button" id="install-plugin">安装</button>
                </div>
            </div>
            
            <!-- 插件列表区域 -->
            <p id="no-plugins-message">暂无安装的插件</p>
            <div id="plugin-list"></div>
        </div>
        <button class="close-button" onclick="togglePluginViewer()">关闭</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();

        // 拼图按钮拖动功能相关变量
        let isDraggingButton = false;
        let buttonOffsetX, buttonOffsetY;
        const puzzleButton = document.getElementById('puzzle-button');
        const dragHint = document.getElementById('drag-hint');
        // 初始位置常量定义
        const DEFAULT_BUTTON_LEFT = 20;
        const DEFAULT_BUTTON_TOP = 20;

        // 创建拼图按钮拖动控制接口
        const pluginbutton = {
            move: {
                // 解锁拖动功能
                unlock: function() {
                    if (!isDraggingButton) {
                        toggleButtonDragMode();
                    }
                },
                // 锁定拖动功能
                lock: function() {
                    if (isDraggingButton) {
                        toggleButtonDragMode();
                    }
                },
                // 重置到初始位置
                reset: function() {
                    resetButtonPosition();
                }
            }
        };

        // Winbox 窗口系统实现
        // 存储所有窗口的数组
        const winboxs = [];
        // 用于生成唯一 ID 的计数器
        let winboxCounter = 0;

        // 创建新窗口的函数
        function createwinbox(windowName, x, y) {
            const winboxId = `winbox-${winboxCounter++}`;
            const winbox = document.createElement('div');
            winbox.id = winboxId;
            winbox.className = 'winbox';
            winbox.style.display = 'none'; // 默认隐藏

            winbox.innerHTML = `
                <div class="winbox-header">
                    <div class="title">${windowName}</div>
                    <div class="controls">
                        <button onclick="closewinbox('${winboxId}')">×</button>
                    </div>
                </div>
                <div class="winbox-content">
                    <div class="output" id="${winboxId}-output"></div>
                </div>
                <div class="resizer"></div>
            `;

            document.body.appendChild(winbox);
            winboxs.push(winbox);

            // 初始化事件监听
            const outputDiv = document.getElementById(`${winboxId}-output`);
            const resizer = winbox.querySelector('.resizer');

            // 使窗口可拖动
            makeDraggable(winbox);

            // 使窗口可调整大小
            makeResizable(winbox);

            // 显示窗口
            togglewinbox(winboxId, x, y);

            // 返回窗口实例
            return {
                id: winboxId,
                element: winbox,
                content: outputDiv,
                msg: function(message) {
                    return new Promise((resolve) => {
                        const dialog = document.createElement('div');
                        dialog.className = 'winbox'; // 使用 winbox 样式
                        dialog.innerHTML = `
                            <div class="winbox-header">
                                <div class="title">Message</div>
                                <div class="controls">
                                    <button onclick="closewinbox('${dialog.id}')">×</button>
                                </div>
                            </div>
                            <div class="winbox-content">
                                <p>${message}</p>
                            </div>
                            <div class="dialog-buttons">
                                <button onclick="closewinbox('${dialog.id}')">OK</button>
                            </div>
                        `;
                        dialog.id = `dialog-${winboxCounter++}`;
                        document.body.appendChild(dialog);
                        dialog.style.display = 'block';

                        // 使对话框可拖动
                        makeDraggable(dialog);

                        // 监听关闭事件
                        dialog.querySelector('.controls button').addEventListener('click', () => {
                            closewinbox(dialog.id);
                        });

                        dialog.querySelector('.dialog-buttons button').addEventListener('click', () => {
                            closewinbox(dialog.id);
                            resolve(true);
                        });
                    });
                },
                input: function(promptText, defaultValue = '') {
                    return new Promise((resolve) => {
                        const dialog = document.createElement('div');
                        dialog.className = 'winbox'; // 使用 winbox 样式
                        dialog.innerHTML = `
                            <div class="winbox-header">
                                <div class="title">Input</div>
                                <div class="controls">
                                    <button onclick="closewinbox('${dialog.id}')">×</button>
                                </div>
                            </div>
                            <div class="winbox-content">
                                <p>${promptText}</p>
                                <input type="text" value="${defaultValue}" class="input-field">
                            </div>
                            <div class="dialog-buttons">
                                <button onclick="closewinbox('${dialog.id}')">Cancel</button>
                                <button onclick="closewinbox('${dialog.id}')">OK</button>
                            </div>
                        `;
                        dialog.id = `dialog-${winboxCounter++}`;
                        document.body.appendChild(dialog);
                        dialog.style.display = 'block';

                        // 使对话框可拖动
                        makeDraggable(dialog);

                        // 监听取消事件
                        dialog.querySelector('.dialog-buttons button:nth-child(1)').addEventListener('click', () => {
                            closewinbox(dialog.id);
                            resolve([false, '']);
                        });

                        // 监听确认事件
                        dialog.querySelector('.dialog-buttons button:nth-child(2)').addEventListener('click', () => {
                            const input = dialog.querySelector('.input-field').value;
                            closewinbox(dialog.id);
                            resolve([true, input]);
                        });
                    });
                },
                setContent: function(content) {
                    outputDiv.innerHTML = content;
                },
                appendContent: function(content) {
                    outputDiv.innerHTML += content;
                },
                setStyle: function(styles) {
                    Object.keys(styles).forEach(key => {
                        winbox.style[key] = styles[key];
                    });
                }
            };
        }

        // 切换窗口显示状态
        function togglewinbox(winboxId, x, y) {
            const winbox = document.getElementById(winboxId);
            if (winbox.style.display === 'none' || winbox.style.display === '') {
                winbox.style.display = 'block';
                if (x !== undefined && y !== undefined) {
                    // 确保窗口位置不超出边框
                    winbox.style.left = `${Math.max(0, Math.min(x, window.innerWidth - winbox.offsetWidth))}px`;
                    winbox.style.top = `${Math.max(0, Math.min(y, window.innerHeight - winbox.offsetHeight))}px`;
                } else {
                    // 默认位置在屏幕中央
                    winbox.style.left = `${(window.innerWidth - winbox.offsetWidth) / 2}px`;
                    winbox.style.top = `${(window.innerHeight - winbox.offsetHeight) / 2}px`;
                }
            } else {
                winbox.style.display = 'none';
            }
        }

        // 关闭窗口
        function closewinbox(winboxId) {
            const winbox = document.getElementById(winboxId);
            if (winbox) {
                winbox.remove();
                winboxs.splice(winboxs.indexOf(winbox), 1);
            }
        }

        // 使窗口可拖动的通用函数
        function makeDraggable(element) {
            let isDragging = false;
            let offsetX, offsetY;

            const header = element.querySelector('.winbox-header');
            header.addEventListener('mousedown', function(event) {
                isDragging = true;
                offsetX = event.clientX - element.getBoundingClientRect().left;
                offsetY = event.clientY - element.getBoundingClientRect().top;
            });

            document.addEventListener('mousemove', function(event) {
                if (isDragging) {
                    const newX = Math.max(0, Math.min(event.clientX - offsetX, window.innerWidth - element.offsetWidth));
                    const newY = Math.max(0, Math.min(event.clientY - offsetY, window.innerHeight - element.offsetHeight));
                    element.style.left = `${newX}px`;
                    element.style.top = `${newY}px`;
                }
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        // 使窗口可调整大小的通用函数
        function makeResizable(element) {
            const resizer = element.querySelector('.resizer');
            let isResizing = false;
            let startX, startY, startWidth, startHeight;

            resizer.addEventListener('mousedown', function(event) {
                isResizing = true;
                startX = event.clientX;
                startY = event.clientY;
                startWidth = element.offsetWidth;
                startHeight = element.offsetHeight;
                event.preventDefault();
            });

            document.addEventListener('mousemove', function(event) {
                if (isResizing) {
                    const newWidth = Math.max(200, Math.min(startWidth + (event.clientX - startX), window.innerWidth));
                    const newHeight = Math.max(100, Math.min(startHeight + (event.clientY - startY), window.innerHeight));
                    element.style.width = `${newWidth}px`;
                    element.style.height = `${newHeight}px`;
                }
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
            });
        }

        // 注册窗口API
        window.register = {
            winbox: createwinbox
        };

        // 插件系统核心变量
        let plugins = [];
        let activePlugins = []; // 跟踪当前激活的插件
        let shortcutsEnabled = true; // 控制快捷键是否启用的标志
        
        // 插件API - 提供给插件使用的方法，新增了窗口相关API
        const pluginAPI = {
            // DOM操作方法
            querySelector: (selector) => document.querySelector(selector),
            querySelectorAll: (selector) => document.querySelectorAll(selector),
            createElement: (tag) => document.createElement(tag),
            getElementById: (id) => document.getElementById(id),
            
            // 修改页面内容的方法
            setInnerHTML: (selector, html) => {
                const element = document.querySelector(selector);
                if (element) element.innerHTML = html;
            },
            setTextContent: (selector, text) => {
                const element = document.querySelector(selector);
                if (element) element.textContent = text;
            },
            appendChild: (parentSelector, child) => {
                const parent = document.querySelector(parentSelector);
                if (parent && child) parent.appendChild(child);
            },
            
            // 添加样式的方法
            addStyle: (css) => {
                const style = document.createElement('style');
                style.textContent = css;
                document.head.appendChild(style);
                return style;
            },
            
            // 事件监听方法
            addEventListener: (selector, event, handler) => {
                const element = document.querySelector(selector);
                if (element) {
                    element.addEventListener(event, handler);
                    return true;
                }
                return false;
            },
            
            // 存储管理方法
            setStorage: (key, value) => {
                try {
                    localStorage.setItem(`plugin_${key}`, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Plugin storage error:', e);
                    return false;
                }
            },
            getStorage: (key) => {
                try {
                    const value = localStorage.getItem(`plugin_${key}`);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error('Plugin storage error:', e);
                    return null;
                }
            },
            
            // 通知主应用的方法
            notify: (message, type = 'info') => {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '4px';
                notification.style.color = 'white';
                notification.style.zIndex = '9999';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                
                // 根据类型设置不同颜色
                switch(type) {
                    case 'success':
                        notification.style.backgroundColor = '#4CAF50';
                        break;
                    case 'error':
                        notification.style.backgroundColor = '#f44336';
                        break;
                    case 'warning':
                        notification.style.backgroundColor = '#ff9800';
                        break;
                    default:
                        notification.style.backgroundColor = '#2196F3';
                }
                
                document.body.appendChild(notification);
                
                // 显示通知
                setTimeout(() => {
                    notification.style.opacity = '1';
                }, 10);
                
                // 3秒后隐藏通知
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },
            
            // 获取已安装插件信息
            getInstalledPlugins: () => {
                return plugins.map(plugin => ({
                    name: plugin.manifest.name,
                    packname: plugin.manifest.packname,
                    description: plugin.manifest.description
                }));
            },

            // 窗口系统API - 新增部分
            createWindow: (windowName, x, y) => {
                return createwinbox(windowName, x, y);
            },
            toggleWindow: (winboxId, x, y) => {
                togglewinbox(winboxId, x, y);
            },
            closeWindow: (winboxId) => {
                closewinbox(winboxId);
            },
            
            // 添加拼图按钮拖动控制API
            toggleButtonDrag: () => {
                toggleButtonDragMode();
            },
            unlockButtonDrag: () => {
                pluginbutton.move.unlock();
            },
            lockButtonDrag: () => {
                pluginbutton.move.lock();
            },
            resetButtonPosition: () => {
                pluginbutton.move.reset();
            }
        };

        // 重置按钮位置到初始状态
        function resetButtonPosition() {
            // 设置按钮回初始位置
            puzzleButton.style.left = `${DEFAULT_BUTTON_LEFT}px`;
            puzzleButton.style.top = `${DEFAULT_BUTTON_TOP}px`;
            
            // 更新本地存储中的位置
            localStorage.setItem('puzzle_button_position', JSON.stringify({
                left: DEFAULT_BUTTON_LEFT,
                top: DEFAULT_BUTTON_TOP
            }));
            
            // 如果当前处于拖动模式，退出拖动模式
            if (isDraggingButton) {
                toggleButtonDragMode();
            }
        }

        // 插件系统相关函数
        function togglePluginViewer() {
            const pluginViewer = document.getElementById('plugin-viewer');
            pluginViewer.style.display = pluginViewer.style.display === 'flex' ? 'none' : 'flex';
            // 隐藏添加插件表单
            document.getElementById('add-plugin-form').classList.remove('visible');
        }

        // 初始化插件系统
        function initializePlugins() {
            // 从localStorage加载插件
            const savedPlugins = localStorage.getItem('papercode_plugins');
            if (savedPlugins) {
                try {
                    plugins = JSON.parse(savedPlugins);
                    // 运行所有已安装的插件
                    plugins.forEach(plugin => {
                        if (!plugin.disabled) { // 只运行未被禁用的插件
                            runPlugin(plugin.code);
                            activePlugins.push(plugin.manifest.packname);
                        }
                    });
                } catch (e) {
                    console.error('加载插件失败:', e);
                    plugins = [];
                }
            }
            updatePluginList();
            
            // 从本地存储加载拼图按钮位置
            const buttonPosition = localStorage.getItem('puzzle_button_position');
            if (buttonPosition) {
                const { left, top } = JSON.parse(buttonPosition);
                puzzleButton.style.left = `${left}px`;
                puzzleButton.style.top = `${top}px`;
            }
        }

        // 更新插件列表显示
        function updatePluginList() {
            const pluginList = document.getElementById('plugin-list');
            const noPluginsMessage = document.getElementById('no-plugins-message');
            
            pluginList.innerHTML = '';
            
            if (plugins.length === 0) {
                // 没有插件时显示提示信息
                noPluginsMessage.style.display = 'block';
                return;
            }
            
            // 有插件时隐藏提示信息
            noPluginsMessage.style.display = 'none';
            
            plugins.forEach((plugin, index) => {
                const manifest = plugin.manifest;
                const pluginItem = document.createElement('div');
                pluginItem.className = 'plugin-item';
                
                const header = document.createElement('div');
                header.className = 'plugin-header';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'plugin-name';
                nameDiv.textContent = manifest.name;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'plugin-actions';
                
                // 添加启用/禁用按钮
                const toggleButton = document.createElement('button');
                toggleButton.className = `plugin-action-button toggle-button ${plugin.disabled ? '' : 'disabled'}`;
                toggleButton.textContent = plugin.disabled ? '启用' : '禁用';
                toggleButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePluginStatus(index);
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'plugin-action-button delete-button';
                deleteButton.textContent = '删除';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePlugin(index);
                    location.reload();
                });
                
                actionsDiv.appendChild(toggleButton);
                actionsDiv.appendChild(deleteButton);
                header.appendChild(nameDiv);
                header.appendChild(actionsDiv);
                
                const packnameDiv = document.createElement('div');
                packnameDiv.className = 'plugin-packname';
                packnameDiv.textContent = manifest.packname;
                
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'plugin-description';
                descriptionDiv.textContent = manifest.description || '无描述';
                
                // 显示插件状态
                const statusDiv = document.createElement('div');
                statusDiv.style.fontSize = '0.8em';
                statusDiv.style.marginTop = '5px';
                statusDiv.style.color = plugin.disabled ? '#ff9800' : '#4CAF50';
                statusDiv.textContent = plugin.disabled ? '已禁用' : '已启用';
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'plugin-details';
                
                // 添加依赖信息
                if (manifest.lib && manifest.lib.length > 0) {
                    const libSection = document.createElement('div');
                    libSection.className = 'plugin-section';
                    
                    const libTitle = document.createElement('div');
                    libTitle.className = 'plugin-section-title';
                    libTitle.textContent = '依赖插件:';
                    
                    const libContent = document.createElement('div');
                    libContent.className = 'plugin-section-content';
                    libContent.textContent = manifest.lib.join(', ');
                    
                    libSection.appendChild(libTitle);
                    libSection.appendChild(libContent);
                    detailsDiv.appendChild(libSection);
                }
                
                // 添加不兼容信息
                if (manifest.incompatible && manifest.incompatible.length > 0) {
                    const incompatibleSection = document.createElement('div');
                    incompatibleSection.className = 'plugin-section';
                    
                    const incompatibleTitle = document.createElement('div');
                    incompatibleTitle.className = 'plugin-section-title';
                    incompatibleTitle.textContent = '不兼容插件:';
                    
                    const incompatibleContent = document.createElement('div');
                    incompatibleContent.className = 'plugin-section-content';
                    incompatibleContent.textContent = manifest.incompatible.join(', ');
                    
                    incompatibleSection.appendChild(incompatibleTitle);
                    incompatibleSection.appendChild(incompatibleContent);
                    detailsDiv.appendChild(incompatibleSection);
                }

                // 添加查看源代码按钮
                const viewSourceButton = document.createElement('button');
                viewSourceButton.className = 'view-source-button';
                viewSourceButton.textContent = '查看源代码';
                viewSourceButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sourceCodeElement = pluginItem.querySelector('.plugin-source-code');
                    sourceCodeElement.classList.toggle('visible');
                    viewSourceButton.textContent = sourceCodeElement.classList.contains('visible') 
                        ? '隐藏源代码' 
                        : '查看源代码';
                });
                detailsDiv.appendChild(viewSourceButton);

                // 添加源代码显示区域
                const sourceCodeElement = document.createElement('div');
                sourceCodeElement.className = 'plugin-source-code';
                // 显示包含manifest的完整源代码
                sourceCodeElement.textContent = plugin.fullCode || '无源代码';
                detailsDiv.appendChild(sourceCodeElement);
                
                pluginItem.appendChild(header);
                pluginItem.appendChild(packnameDiv);
                pluginItem.appendChild(descriptionDiv);
                pluginItem.appendChild(statusDiv);
                pluginItem.appendChild(detailsDiv);
                
                // 点击显示/隐藏详情 - 修改事件处理逻辑
                pluginItem.addEventListener('click', (e) => {
                    // 检查点击目标是否是代码块或其内部元素
                    if (!e.target.closest('.plugin-source-code')) {
                        detailsDiv.classList.toggle('visible');
                    }
                });
                
                pluginList.appendChild(pluginItem);
            });
        }

        // 切换插件启用/禁用状态
        function togglePluginStatus(index) {
            const plugin = plugins[index];
            plugin.disabled = !plugin.disabled;
            
            if (plugin.disabled) {
                // 禁用插件 - 刷新页面以完全移除插件效果
                savePlugins();
                location.reload();
            } else {
                // 启用插件
                try {
                    runPlugin(plugin.code);
                    activePlugins.push(plugin.manifest.packname);
                    savePlugins();
                    updatePluginList();
                } catch (e) {
                    alert(`启用插件失败: ${e.message}`);
                    plugin.disabled = true;
                }
            }
        }

        // 解析插件代码，提取manifest
        function parsePluginCode(code) {
            try {
                // 保存完整代码（包含manifest）
                const fullCode = code;
                
                // 尝试提取manifest部分
                const manifestMatch = code.match(/"manifest"\s*:\s*\{([\s\S]*?)\}/);
                if (!manifestMatch) {
                    return { error: '插件代码中未找到manifest' };
                }
                
                // 尝试解析manifest
                const manifestStr = `{${manifestMatch[1]}}`;
                const manifest = JSON.parse(manifestStr);
                
                // 验证必要字段
                if (!manifest.name || !manifest.packname) {
                    return { error: 'manifest中缺少name或packname' };
                }
                
                // 验证packname格式 (至少三部分)
                const packnameParts = manifest.packname.split('.');
                if (packnameParts.length < 3) {
                    return { error: 'packname格式不正确，至少需要三部分(xxx.xxx.xxx)' };
                }
                
                // 提取纯代码部分（去除manifest）
                const codeWithoutManifest = code.replace(/"manifest"\s*:\s*\{[\s\S]*?\}/, '');
                
                return {
                    manifest: manifest,
                    code: codeWithoutManifest,
                    fullCode: fullCode  // 返回包含manifest的完整代码
                };
            } catch (e) {
                return { error: `解析插件失败: ${e.message}` };
            }
        }

        // 检查插件依赖
        function checkPluginDependencies(manifest) {
            if (!manifest.lib || manifest.lib.length === 0) {
                return { valid: true };
            }
            
            const missingDeps = [];
            manifest.lib.forEach(depPackname => {
                const found = plugins.some(plugin => plugin.manifest.packname === depPackname);
                if (!found) {
                    missingDeps.push(depPackname);
                }
            });
            
            if (missingDeps.length > 0) {
                return {
                    valid: false,
                    missing: missingDeps
                };
            }
            
            return { valid: true };
        }

        // 检查插件兼容性
        function checkPluginCompatibility(manifest) {
            // 检查是否与已安装插件不兼容
            if (manifest.incompatible && manifest.incompatible.length > 0) {
                for (const incompatiblePackname of manifest.incompatible) {
                    const found = plugins.some(plugin => plugin.manifest.packname === incompatiblePackname);
                    if (found) {
                        return {
                            valid: false,
                            reason: `与已安装的插件冲突: ${incompatiblePackname}`
                        };
                    }
                }
            }
            
            // 检查已安装插件是否与当前插件不兼容
            for (const installedPlugin of plugins) {
                if (installedPlugin.manifest.incompatible && 
                    installedPlugin.manifest.incompatible.includes(manifest.packname)) {
                    return {
                        valid: false,
                        reason: `已安装的插件 ${installedPlugin.manifest.name} 与当前插件冲突`
                    };
                }
            }
            
            return { valid: true };
        }

        // 检查插件是否已安装
        function isPluginInstalled(packname) {
            return plugins.some(plugin => plugin.manifest.packname === packname);
        }

        // 安装插件
        function installPlugin(code) {
            const result = parsePluginCode(code);
            
            if (result.error) {
                showError('plugin-code-error', result.error);
                return false;
            }
            
            const { manifest, code: pluginCode, fullCode } = result;
            
            // 检查是否已安装
            if (isPluginInstalled(manifest.packname)) {
                showError('plugin-code-error', `已安装同名插件: ${manifest.packname}`);
                return false;
            }
            
            // 检查依赖
            const depCheck = checkPluginDependencies(manifest);
            if (!depCheck.valid) {
                showError('plugin-code-error', `缺少依赖插件: ${depCheck.missing.join(', ')}`);
                return false;
            }
            
            // 检查兼容性
            const compatCheck = checkPluginCompatibility(manifest);
            if (!compatCheck.valid) {
                showError('plugin-code-error', compatCheck.reason);
                return false;
            }
            
            // 运行插件
            try {
                runPlugin(pluginCode);
            } catch (e) {
                showError('plugin-code-error', `插件运行出错: ${e.message}`);
                return false;
            }
            
            // 添加到插件列表
            plugins.push({
                manifest: manifest,
                code: pluginCode,
                fullCode: fullCode,  // 保存包含manifest的完整代码
                disabled: false      // 默认启用
            });
            
            // 保存到localStorage
            savePlugins();
            
            // 更新插件列表
            updatePluginList();
            
            // 隐藏添加插件表单
            document.getElementById('add-plugin-form').classList.remove('visible');
            // 清空输入
            document.getElementById('plugin-code').value = '';
            
            return true;
        }

        // 运行插件代码
        function runPlugin(code) {
            // 创建一个沙箱环境运行插件代码，传入pluginAPI
            const pluginFunction = new Function('api', code);
            pluginFunction(pluginAPI);
        }

        // 从文件安装插件
        function installPluginFromFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const code = e.target.result;
                    const success = installPlugin(code);
                    if (success) {
                        // 重置文件输入
                        document.getElementById('plugin-file').value = '';
                    }
                } catch (e) {
                    showError('plugin-file-error', `文件读取错误: ${e.message}`);
                }
            };
            
            reader.onerror = function() {
                showError('plugin-file-error', '文件读取失败');
            };
            
            reader.readAsText(file);
        }

        // 删除插件
        function deletePlugin(index) {
            if (confirm('确定要删除这个插件吗？')) {
                plugins.splice(index, 1);
                savePlugins();
                updatePluginList();
            }
        }

        // 保存插件到localStorage
        function savePlugins() {
            localStorage.setItem('papercode_plugins', JSON.stringify(plugins));
        }

        // 显示错误信息
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // 3秒后隐藏错误信息
            setTimeout(() => {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }, 3000);
        }

        // 关闭所有查看器窗口
        function closeAllViewers() {
            document.getElementById('plugin-viewer').style.display = 'none';
            // 隐藏添加插件表单
            document.getElementById('add-plugin-form').classList.remove('visible');
        }

        // 切换拼图按钮的拖动模式
        function toggleButtonDragMode() {
            isDraggingButton = !isDraggingButton;
            
            if (isDraggingButton) {
                // 进入拖动模式
                puzzleButton.classList.add('dragging');
                puzzleButton.title = "拖动按钮 - 按ESC退出拖动模式";
                dragHint.style.display = 'block';
                
                // 临时移除点击事件监听器
                const clickHandler = puzzleButton.onclick;
                puzzleButton.onclick = null;
                
                // 记录当前的点击处理器，以便退出时恢复
                puzzleButton.dataset.clickHandler = 'true';
                puzzleButton._originalClick = clickHandler;
            } else {
                // 退出拖动模式
                puzzleButton.classList.remove('dragging');
                puzzleButton.title = "插件管理";
                dragHint.style.display = 'none';
                
                // 恢复点击事件监听器
                if (puzzleButton.dataset.clickHandler) {
                    puzzleButton.onclick = puzzleButton._originalClick;
                    delete puzzleButton.dataset.clickHandler;
                    delete puzzleButton._originalClick;
                }
            }
        }

        // 初始化拼图按钮拖动功能
        function initButtonDrag() {
            // 鼠标按下时记录偏移量
            puzzleButton.addEventListener('mousedown', (e) => {
                if (isDraggingButton) {
                    const rect = puzzleButton.getBoundingClientRect();
                    buttonOffsetX = e.clientX - rect.left;
                    buttonOffsetY = e.clientY - rect.top;
                    e.preventDefault(); // 防止拖动时选中文本
                }
            });
            
            // 鼠标移动时拖动按钮
            document.addEventListener('mousemove', (e) => {
                if (isDraggingButton) {
                    const newLeft = e.clientX - buttonOffsetX;
                    const newTop = e.clientY - buttonOffsetY;
                    
                    // 确保按钮不会移出窗口
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const buttonWidth = puzzleButton.offsetWidth;
                    const buttonHeight = puzzleButton.offsetHeight;
                    
                    const constrainedLeft = Math.max(0, Math.min(newLeft, windowWidth - buttonWidth));
                    const constrainedTop = Math.max(0, Math.min(newTop, windowHeight - buttonHeight));
                    
                    puzzleButton.style.left = `${constrainedLeft}px`;
                    puzzleButton.style.top = `${constrainedTop}px`;
                    
                    // 保存位置到本地存储
                    localStorage.setItem('puzzle_button_position', JSON.stringify({
                        left: constrainedLeft,
                        top: constrainedTop
                    }));
                }
            });
            
            // 鼠标释放时结束拖动
            document.addEventListener('mouseup', () => {
                // 不做任何操作，保持拖动模式直到用户再次按下alt+m或esc
            });
        }

        // 初始化插件系统事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化拼图按钮拖动功能
            initButtonDrag();
            
            // 为输入框添加焦点和失焦事件监听器
            const pluginCodeInput = document.getElementById('plugin-code');
            pluginCodeInput.addEventListener('focus', () => {
                shortcutsEnabled = false; // 输入框获得焦点时禁用快捷键
            });
            pluginCodeInput.addEventListener('blur', () => {
                shortcutsEnabled = true; // 输入框失去焦点时启用快捷键
            });
            
            // 拼图按钮点击事件 - 打开插件管理界面
            puzzleButton.addEventListener('click', togglePluginViewer);
            
            // 添加插件按钮点击事件 - 只有点击这个按钮才显示安装界面
            document.getElementById('add-plugin-button').addEventListener('click', () => {
                document.getElementById('add-plugin-form').classList.add('visible');
            });
            
            // 取消添加插件
            document.getElementById('cancel-add-plugin').addEventListener('click', () => {
                document.getElementById('add-plugin-form').classList.remove('visible');
                // 清空错误信息
                document.getElementById('plugin-code-error').textContent = '';
                document.getElementById('plugin-file-error').textContent = '';
            });
            
            // 安装插件按钮点击事件
            document.getElementById('install-plugin').addEventListener('click', () => {
                const activeMethod = document.querySelector('.install-method.active').dataset.method;
                
                if (activeMethod === 'text') {
                    const code = document.getElementById('plugin-code').value.trim();
                    if (!code) {
                        showError('plugin-code-error', '请输入插件代码');
                        return;
                    }
                    installPlugin(code);
                } else if (activeMethod === 'file') {
                    const fileInput = document.getElementById('plugin-file');
                    if (!fileInput.files || fileInput.files.length === 0) {
                        showError('plugin-file-error', '请选择一个JS文件');
                        return;
                    }
                    installPluginFromFile(fileInput.files[0]);
                }
            });
            
            // 安装方式切换
            const installMethods = document.querySelectorAll('.install-method');
            installMethods.forEach(method => {
                method.addEventListener('click', () => {
                    // 移除所有active类
                    installMethods.forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.install-content').forEach(c => c.classList.remove('active'));
                    
                    // 给当前点击的添加active类
                    method.classList.add('active');
                    const methodName = method.dataset.method;
                    document.getElementById(`${methodName}-install`).classList.add('active');
                    
                    // 清空错误信息
                    document.getElementById('plugin-code-error').textContent = '';
                    document.getElementById('plugin-file-error').textContent = '';
                });
            });
            
            // 文件选择变化事件
            document.getElementById('plugin-file').addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    document.getElementById('plugin-file-error').textContent = '';
                }
            });
            
            // 初始化插件系统
            initializePlugins();

            // 创建一个示例窗口
            // const exampleWindow = window.register.winbox('示例窗口', 100, 100);
            // exampleWindow.setContent('<p>这是一个示例窗口</p>');
        });

        // 插件相关的键盘事件处理
        document.addEventListener('keydown', (event) => {
            // 如果快捷键被禁用，则不处理任何快捷键
            if (!shortcutsEnabled) {
                return;
            }
            
            // 处理alt+m和alt+M快捷键切换拖动模式
            if ((event.key === 'm' || event.key === 'M') && event.altKey) {
                event.preventDefault();
                toggleButtonDragMode();
            }
            // 处理alt+r和alt+R快捷键重置位置
            else if ((event.key === 'r' || event.key === 'R') && event.altKey) {
                event.preventDefault();
                resetButtonPosition();
            }
            // 处理ESC键退出拖动模式
            else if (event.key === 'Escape' && isDraggingButton) {
                event.preventDefault();
                toggleButtonDragMode();
            }
            // 原有的快捷键
            else if (event.key.toLowerCase() === 'insert') {
                // 按Insert键打开/关闭插件管理界面
                togglePluginViewer();
            } else if (event.key === 'Escape' && !isDraggingButton) {
                // 按Esc键关闭所有查看器窗口
                closeAllViewers();
            }
        });
    </script>
</body>
</html>
